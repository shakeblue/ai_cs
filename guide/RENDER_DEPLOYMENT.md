# Render Deployment Guide

This guide explains how to deploy your AI CS application (with Python crawler) to Render.

## Prerequisites

1. A Render account (https://render.com)
2. Your code pushed to a Git repository (GitHub, GitLab, or Bitbucket)
3. Supabase credentials ready

## Deployment Steps

### Option 1: Using render.yaml (Recommended)

1. **Push the configuration files to your repository:**
   ```bash
   git add render.yaml scripts/render-build.sh
   git commit -m "Add Render deployment configuration"
   git push
   ```

2. **Create a new Blueprint Instance on Render:**
   - Go to https://dashboard.render.com
   - Click "New +" → "Blueprint"
   - Connect your repository
   - Render will automatically detect `render.yaml`
   - Click "Apply"

3. **Set Environment Variables:**

   The following environment variables will be prompted. Set them in Render dashboard:

   **Backend Service:**
   - `SUPABASE_URL`: Your Supabase project URL
   - `SUPABASE_SERVICE_KEY`: Your Supabase service role key
   - `SUPABASE_ANON_KEY`: Your Supabase anon key
   - `JWT_SECRET`: Will be auto-generated by Render
   - `NODE_ENV`: Set to `production`
   - `PORT`: Set to `3001`

   **Frontend Service:**
   - `REACT_APP_API_URL`: Set to your backend URL (e.g., `https://ai-cs-backend.onrender.com/api`)

4. **Deploy:**
   - Render will automatically build and deploy both services
   - Backend build takes ~5-10 minutes (includes Playwright installation)
   - Frontend build takes ~2-3 minutes

### Option 2: Manual Service Creation

If you prefer to create services manually:

#### Backend Service

1. **Create Web Service:**
   - Click "New +" → "Web Service"
   - Connect your repository
   - **Name:** `ai-cs-backend`
   - **Region:** Oregon (or your preferred region)
   - **Branch:** `main`
   - **Root Directory:** Leave empty
   - **Runtime:** Node
   - **Build Command:**
     ```bash
     ./scripts/render-build.sh
     ```
   - **Start Command:**
     ```bash
     cd backend && npm start
     ```
   - **Plan:** Starter ($7/month) or Free

2. **Add Environment Variables:**
   Go to Environment tab and add:
   ```
   NODE_ENV=production
   PORT=3001
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_SERVICE_KEY=your-service-key
   SUPABASE_ANON_KEY=your-anon-key
   JWT_SECRET=your-secret-key
   ```

3. **Health Check:**
   - Path: `/health`
   - Port: `3001`

#### Frontend Service

1. **Create Static Site:**
   - Click "New +" → "Static Site"
   - Connect your repository
   - **Name:** `ai-cs-frontend`
   - **Branch:** `main`
   - **Root Directory:** Leave empty
   - **Build Command:**
     ```bash
     cd frontend && npm install && npm run build
     ```
   - **Publish Directory:**
     ```
     frontend/build
     ```

2. **Add Environment Variable:**
   ```
   REACT_APP_API_URL=https://your-backend-url.onrender.com/api
   ```

3. **Add Rewrite Rule:**
   - In the "Redirects/Rewrites" section, add:
   - **Source:** `/*`
   - **Destination:** `/index.html`
   - **Type:** Rewrite

## Important Notes

### Python/Playwright on Render

The build script (`render-build.sh`) handles:
- ✅ Creating Python virtual environment
- ✅ Installing Python dependencies from `requirements.txt`
- ✅ Installing Playwright browser (Chromium)
- ✅ Installing system dependencies for Playwright

### Build Time

- **First build:** 8-12 minutes (installing Playwright browsers)
- **Subsequent builds:** 3-5 minutes (cached dependencies)

### Disk Usage

Render provides:
- **Free tier:** 512 MB disk
- **Starter tier:** 20 GB disk ✅ (Recommended - Playwright needs ~200MB)

### Memory Requirements

The crawler needs sufficient memory:
- **Free tier:** 512 MB (may work but tight)
- **Starter tier:** 2 GB ✅ (Recommended)

### Environment-Specific Configuration

The crawler paths are already configured for production in:
- `backend/src/routes/crawlerRoutes.js`

The paths use relative paths and will work in any environment.

## Testing Deployment

1. **Check Backend Health:**
   ```bash
   curl https://your-backend-url.onrender.com/health
   ```

2. **Test Crawler Endpoint:**
   ```bash
   curl -X POST https://your-backend-url.onrender.com/api/crawler/crawl \
     -H "Content-Type: application/json" \
     -d '{"url": "https://view.shoppinglive.naver.com/replays/1776510", "saveToDb": true}'
   ```

3. **Access Frontend:**
   Open `https://your-frontend-url.onrender.com/admin` and test the crawler tab

## Troubleshooting

### Build Fails

**Error:** `playwright install` fails
**Solution:** Make sure you're on Starter plan or higher (needs more disk space)

**Error:** Python not found
**Solution:** Render provides Python 3. If issues persist, add to build script:
```bash
apt-get update && apt-get install -y python3 python3-pip python3-venv
```

### Crawler Times Out

**Error:** 500 error when crawling
**Solution:** Increase timeout in `crawlerRoutes.js` or upgrade to higher plan for more resources

### Database Save Fails

**Error:** Can't connect to Supabase
**Solution:** Check environment variables are set correctly in Render dashboard

## Cost Estimate

**Minimal Setup (Starter Plan):**
- Backend Web Service: $7/month
- Frontend Static Site: Free
- **Total:** ~$7/month

**Production Setup (Professional):**
- Backend Web Service: $25/month (4 GB RAM, autoscaling)
- Frontend Static Site: Free
- **Total:** ~$25/month

## Updating Your Deployment

To deploy updates:
```bash
git add .
git commit -m "Your update message"
git push
```

Render will automatically rebuild and deploy on every push to your main branch.

## Auto-Deploy Settings

By default, auto-deploy is enabled. To disable:
1. Go to your service in Render dashboard
2. Settings → Build & Deploy
3. Toggle "Auto-Deploy" off

---

## Quick Start Checklist

- [ ] Push `render.yaml` and `scripts/render-build.sh` to your repo
- [ ] Create Blueprint Instance on Render
- [ ] Set all environment variables
- [ ] Wait for build to complete (~10 min)
- [ ] Test backend health endpoint
- [ ] Test crawler via admin panel
- [ ] Configure custom domain (optional)

Need help? Check Render docs: https://render.com/docs
